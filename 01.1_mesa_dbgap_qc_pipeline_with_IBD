########new GWAS QC for mesa dbgap data (not imputed)
$DIR = /home/lauren/MESA_dbGaP_55081/phg000071.v2.NHLBI_SHARE_MESA.genotype-calls-matrixfmt.c1/plink_qc_files/
cd $DIR
#1. merge two mesa data sets 

#2. change affy ID to rsid...new bim file


#3. use newly formated bim file rsids...need to liftover to hg19 from hg18 (later)
#make sure you are in the correct directory and/or have the correct path to your files while using plink flags

plink --bed MESA_all_merged.bed --bim MESA_all_merged_rsid_new.bim  --fam MESA_all_merged.fam --make-bed  --out /home/lauren/MESA_dbGaP_55081/all_mesa_merged/MESA_all_merged_1

#515881 MB RAM detected; reserving 257940 MB for main workspace.
#909622 variants loaded from .bim file.
#7377 people (3440 males, 3937 females) loaded from .fam.
#Using 1 thread (no multithreaded calculations invoked).
#Before main variant filters, 5450 founders and 1927 nonfounders present.
#Calculating allele frequencies... done.
#Warning: 447174 het. haploid genotypes present (see
#/home/lauren/MESA_dbGaP_55081/phg000071.v2.NHLBI_SHARE_MESA.genotype-calls-matrixfmt.c1/plink_qc_files/MESA_c1_start.hh
#); many commands treat these as missing.
#Warning: Nonmissing nonmale Y chromosome genotype(s) present; many commands
#treat these as missing.
#Total genotyping rate is 0.996968.
#909622 variants and 7377 people pass filters and QC.
#Note: No phenotypes present.

#4. Check sex and calculate call rates for flagging poorly called SNPs and individuals

plink --bfile MESA_all_merged_1 --check-sex --missing --out MESA_all_merged_1

#515881 MB RAM detected; reserving 257940 MB for main workspace.
#909622 variants loaded from .bim file.
#7377 people (3440 males, 3937 females) loaded from .fam.
#Using 1 thread (no multithreaded calculations invoked).
#Before main variant filters, 5450 founders and 1927 nonfounders present.
#Calculating allele frequencies... done.
#Warning: 447174 het. haploid genotypes present (see MESA_c1_start.sexmiss.hh );
#many commands treat these as missing.
#Warning: Nonmissing nonmale Y chromosome genotype(s) present; many commands
#treat these as missing.
#Total genotyping rate is 0.996968.
#--missing: Sample missing data report written to MESA_c1_start.sexmiss.imiss,
#and variant-based missing data report written to MESA_c1_start.sexmiss.lmiss.
#909622 variants and 7377 people pass filters and QC.
#Note: No phenotypes present.
#--check-sex: 36538 Xchr and 0 Ychr variant(s) scanned, 689 problems detected.
#Report written to MESA_c1_start.sexmiss.sexcheck .

#5. use autosome flag to remove all non-autosomal chromosomes

plink --bfile MESA_all_merged_1 --autosome --make-bed --out MESA_all_merged_autosome


#6. Recalculate individual call rates after removing SNPs with call rates <99%
plink --bfile MESA_all_merged_autosome --geno 0.01 --make-bed --out MESA_all_merged_autosome.geno0.01

#515881 MB RAM detected; reserving 257940 MB for main workspace.
#909622 variants loaded from .bim file.
#7377 people (3440 males, 3937 females) loaded from .fam.
#Using 1 thread (no multithreaded calculations invoked).
#Before main variant filters, 5450 founders and 1927 nonfounders present.
#Calculating allele frequencies... done.
#Warning: 447174 het. haploid genotypes present (see MESA_c1_start.geno0.01.hh
#); many commands treat these as missing.
#Warning: Nonmissing nonmale Y chromosome genotype(s) present; many commands
#treat these as missing.
#Total genotyping rate is 0.996968.
#53838 variants removed due to missing genotype data (--geno).
#855784 variants and 7377 people pass filters and QC.
#Note: No phenotypes present.

plink --bfile MESA_all_merged_autosome.geno0.01 --missing --out MESA_all_merged_autosome.geno0.01

#515881 MB RAM detected; reserving 257940 MB for main workspace.
#855784 variants loaded from .bim file.
#7377 people (3440 males, 3937 females) loaded from .fam.
#Using 1 thread (no multithreaded calculations invoked).
#Before main variant filters, 5450 founders and 1927 nonfounders present.
#Calculating allele frequencies... done.
#Warning: 404203 het. haploid genotypes present (see MESA_c1_start.geno0.01.hh
#); many commands treat these as missing.
#Warning: Nonmissing nonmale Y chromosome genotype(s) present; many commands
#treat these as missing.
#Total genotyping rate is 0.998716.
#--missing: Sample missing data report written to MESA_c1_start.geno0.01.imiss,
#and variant-based missing data report written to MESA_c1_start.geno0.01.lmiss.



#5. LD prune (rm 1 SNP if r2>0.3 in 50 SNP window) for relationship check and heterozygosity calculation
plink --bfile MESA_all_merged_autosome.geno0.01 --indep-pairwise 50 5 0.3 --out MESA_all_merged_autosome.geno0.01.LD3

#6. Relationship check
plink --bfile MESA_all_merged_autosome.geno0.01 --extract MESA_all_merged_autosome.geno0.01.LD3.prune.in --genome --min 0.05 --out MESA_all_merged_autosome.geno0.01.LD3.0.05

#6.1 
####IBD analysis in R
install.packages("dplyr")
install.packages("tidyr")
install.packages("ggplot2")
install.packages("data.table")

library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)

"%&%" = function(a,b) paste(a,b,sep="")
my.dir = "/home/lauren/MESA_dbGaP_55081/all_mesa_merged/"

lmiss <- fread(my.dir %&% "MESA_all_merged_1.lmiss")
hist(lmiss$F_MISS)
##SNP count at start
dim(lmiss)[1]
##SNPs with call rates > 99%
table(lmiss$F_MISS<0.01)

##after removing SNPs with < 99% call rates, look at sample F_MISS (proportion of missing SNPs)
imiss <- fread(my.dir %&% "MESA_all_merged_autosome.geno0.01.imiss")
hist(imiss$F_MISS)
##looks great, all individuals now have >99.4% call rates
newlmiss <- fread(my.dir %&% "MESA_all_merged_autosome.geno0.01.lmiss")
hist(newlmiss$F_MISS)
##SNP and individual count after rm low-call SNPs
dim(newlmiss)[1]
dim(imiss)[1]

ibd <- read.table(my.dir %&% "MESA_all_merged_autosome.geno0.01.LD3.0.05.genome",header=T)

png(filename="mesa_all_ibd.png",res=100)
ggplot(data=ibd,aes(x=Z0,y=Z1))+geom_point(alpha=0.25)+theme_bw()
dev.off()

##pull duplicates
dups <- dplyr::filter(ibd,PI_HAT==1)
dim(dups)

##verify dups with matching IIDs are expected dups by checking plate layout file:
expdups <- dplyr::filter(dups,as.character(IID1) == as.character(IID2))
dim(expdups)

##pull unexpected duplicates, IIDs (PATNOs) don't match
unexp <- dplyr::filter(dups,as.character(IID1) != as.character(IID2))
print(unexp)
##forward list to Pt Study for checking
write.table(unexp, my.dir %&% "mesa_duplicates.txt", quote=F,row.names=F)

####go back to plink and remove duplicates from files
###if no duplicates, separate populations

#7. Separate pops
**make new *pop*_samples file from python script that pulls FID/IID pairs from fam file in /home/lauren/scripts/make_samples_keep.py

### location of sample files here /home/lauren/MESA_dbGaP_55081/all_mesa_merged
# example: plink --bfile MESA_all_merged_autosome.geno0.01 --keep /home/lauren/MESA_dbGaP_55081/all_mesa_merged/afa_samples.txt --make-bed --out MESA_AFA_merged_autosome.geno0.01


plink --bfile MESA_all_merged_autosome.geno0.01 --keep afa_samples.txt --make-bed --out MESA_AFA_merged_autosome.geno0.01

plink --bfile MESA_all_merged_autosome.geno0.01 --keep his_samples.txt --make-bed --out MESA_HIS_merged_autosome.geno0.01

plink --bfile MESA_all_merged_autosome.geno0.01 --keep cau_samples.txt --make-bed --out MESA_CAU_merged_autosome.geno0.01


#8. LD prune (rm 1 SNP if r2>0.3 in 50 SNP window) for relationship check and heterozygosity calculation
plink --bfile MESA_AFA_merged_autosome.geno0.01 --indep-pairwise 50 5 0.3 --out MESA_AFA_merged_autosome.geno0.01.LD3

plink --bfile MESA_HIS_merged_autosome.geno0.01 --indep-pairwise 50 5 0.3 --out MESA_HIS_merged_autosome.geno0.01.LD3

plink --bfile MESA_CAU_merged_autosome.geno0.01 --indep-pairwise 50 5 0.3 --out MESA_CAU_merged_autosome.geno0.01.LD3


#9.Relationship check for individual pops
plink --bfile MESA_AFA_merged_autosome.geno0.01 --extract MESA_AFA_merged_autosome.geno0.01.LD3.prune.in --genome --min 0.05 --out MESA_AFA_merged_autosome.geno0.01.LD3.0.125

plink --bfile MESA_HIS_merged_autosome.geno0.01 --extract MESA_HIS_merged_autosome.geno0.01.LD3.prune.in --genome --min 0.05 --out MESA_HIS_merged_autosome.geno0.01.LD3.0.05

plink --bfile MESA_CAU_merged_autosome.geno0.01 --extract MESA_CAU_merged_autosome.geno0.01.LD3.prune.in --genome --min 0.05 --out MESA_CAU_merged_autosome.geno0.01.LD3.0.05

#####repeat step 6.1 with individual pops

#10.Check heterozygosity (across all autosomal SNPs) -- look at that distribution across individuals to check for and rm outliers (F: mean +/-3 sd)
plink --bfile MESA_AFA_merged_autosome.geno0.01 --het --out MESA_AFA_merged_autosome.geno0.01

plink --bfile MESA_HIS_merged_autosome.geno0.01 --het --out MESA_HIS_merged_autosome.geno0.01

plink --bfile MESA_CAU_merged_autosome.geno0.01 --het --out MESA_CAU_merged_autosome.geno0.01

#10.1 make outlier file in R---do this for each pop---AFA example here
afa_het<-read.table(my.dir %&% "MESA_AFA_merged_autosome.geno0.01.het", header = T)

hist(afa_het$F,50)
summary(afa_het$F)

sortHET_afa<-afa_het[order(afa_het$F),]

outliers_afa<-data.frame()

for(i in 1:length(sortHET_afa$F)){
	if(sortHET_afa[i,6] > (mean(sortHET_afa$F)+3*sd(sortHET_afa$F))){
		outliers <- rbind(outliers,sortHET_afa[i,])
	}
	if(sortHET_afa[i,6] < (mean(sortHET_afa$F)-3*sd(sortHET_afa$F))){
		outliers <- rbind(outliers,sortHET_afa[i,])
	}
}
hetoutliers_afa <- select(outliers_afa,FID,IID)
dim(hetoutliers)
write.table(hetoutliers_afa,file=my.dir %&% "afa_3sd.txt",quote=F,col.names=F,row.names=F)

#11. made outliers outside of -/+ 3 SD 
plink --bfile MESA_AFA_merged_autosome.geno0.01 --remove afa_3sd.txt --make-bed --out MESA_AFA_merged_autosome.geno0.01.sd

plink --bfile MESA_HIS_merged_autosome.geno0.01 --remove his_3sd.txt --make-bed --out MESA_HIS_merged_autosome.geno0.01.sd

plink --bfile MESA_CAU_merged_autosome.geno0.01 --remove cau_3sd.txt --make-bed --out MESA_CAU_merged_autosome.geno0.01.sd


#12. liftover steps---change from genome build hg18 to hg19
#make ped/map files of pop plink files
plink --bfile MESA_AFA_merged_autosome.geno0.01.sd --recode --out MESA_AFA_4lift

plink --bfile MESA_HIS_merged_autosome.geno0.01.sd --recode --out MESA_HIS_4lift

plink --bfile MESA_CAU_merged_autosome.geno0.01.sd --recode --out MESA_CAU_4lift

#run liftover script with new ped/mapfiles --example with AFA
python /home/lauren/MESA_dbGaP_55081/all_mesa_merged/liftover/liftOverPlink.py -map MESA_AFA_4lift.map --out AFA_lifted --chain /home/lauren/MESA_dbGaP_55081/all_mesa_merged/liftover/hg18ToHg19.over.chain.gz

cut -f 4 AFA_lifted.bed.unlifted | sed "/^#/d" >> afa_to_exclude.txt

plink --file MESA_AFA_4lift --exclude afa_to_exclude.txt --recode --out AFA_tolift

python /home/lauren/MESA_dbGaP_55081/all_mesa_merged/liftover/liftOverPlink.py -map AFA_tolift.map --out AFA_lifted_use --chain hg18ToHg19.over.chain.gz

plink --ped AFA_tolift --map AFA_lifted_use.map --recode --out MESA_AFA_lifted_final

#13. LD prune MESA files with removed individuals
plink --bfile MESA_AFA_lifted --indep-pairwise 50 5 0.3 --out MESA_AFA_merged_autosome.geno0.01.sd.prune

plink --bfile MESA_AFA_lifted --indep-pairwise 50 5 0.3 --out MESA_HIS_merged_autosome.geno0.01.sd.prune

plink --bfile MESA_AFA_lifted --indep-pairwise 50 5 0.3 --out MESA_CAU_merged_autosome.geno0.01.sd.prune


#14. Make bed files after LD pruning and extracting relatives...to use with PCA
plink --bfile MESA_AFA_lifted --extract MESA_AFA_merged_autosome.geno0.01.sd.prune.prune.in --out MESA_AFA_merged_autosome.geno0.01.sd.4pca --make-bed

plink --bfile MESA_AFA_lifted --extract MESA_HIS_merged_autosome.geno0.01.sd.prune.prune.in --out MESA_HIS_merged_autosome.geno0.01.sd.4pca --make-bed

plink --bfile MESA_AFA_lifted --extract MESA_CAU_merged_autosome.geno0.01.sd.prune.prune.in --out MESA_CAU_merged_autosome.geno0.01.sd.4pca --make-bed



#15. Merge pruned data with HAPMAP
plink --bfile MESA_AFA_use_4pca --bmerge /home/lauren/MESA_dbGaP_55081/all_mesa_merged/hapmap_hg19/HM3_ASN_CEU_YRI_Unrelated_hg19_noAmbig --make-bed --out MESA_AFA_mergedHAPMAP

plink --bfile MESA_HIS_use_4pca --bmerge /home/lauren/MESA_dbGaP_55081/all_mesa_merged/hapmap_hg19/HM3_ASN_CEU_YRI_Unrelated_hg19_noAmbig --make-bed --out MESA_HIS_mergedHAPMAP

plink --bfile MESA_CAU_use_4pca --bmerge /home/lauren/MESA_dbGaP_55081/all_mesa_merged/hapmap_hg19/HM3_ASN_CEU_YRI_Unrelated_hg19_noAmbig --make-bed --out MESA_CAU_mergedHAPMAP


#16. reformat fam file for PCA
##unmerged
awk '{print $1, $2, $3, $4, $5, 1}' MESA_AFA_use_4pca.fam > MESA_AFA_merged_autosome.geno0.01.sd.4pca.fam

awk '{print $1, $2, $3, $4, $5, 1}' MESA_HIS_use_4pca.fam > MESA_HIS_merged_autosome.geno0.01.sd.4pca.fam

awk '{print $1, $2, $3, $4, $5, 1}' MESA_CAU_use_4pca.fam > MESA_CAU_merged_autosome.geno0.01.sd.4pca.fam

###merged with hapmap
awk '{print $1, $2, $3, $4, $5, 1}' MESA_AFA_mergedHAPMA.fam > MESA_AFA_merged_hapmap.4pca.fam

awk '{print $1, $2, $3, $4, $5, 1}' MESA_HIS_mergedHAPMAP.fam > MESA_HIS_merged_hapmap.4pca.fam

awk '{print $1, $2, $3, $4, $5, 1}' MESA_CAU_mergedHAPMAP.fam > MESA_CAU_merged_hapmap.4pca.fam

#17. Make ped/map files for PCA
##unmerged
plink --bfile MESA_AFA_use_4pca --recode --out MESA_AFA_merged_autosome.geno0.01.sd.4pca

plink --bfile MESA_HIS_use_4pca --recode --out MESA_HIS_merged_autosome.geno0.01.sd.4pca

plink --bfile MESA_CAU_use_4pca --recode --out MESA_CAU_merged_autosome.geno0.01.sd.4pca

###merged with hapmap hg19
plink --bfile MESA_AFA_mergedHAPMAP --recode --out MESA_AFA_merged_hapmap.4pca

plink --bfile MESA_HIS_mergedHAPMAP --recode --out MESA_HIS_merged_hapmap.4pca

plink --bfile MESA_CAU_mergedHAPMAP --recode --out MESA_CAU_merged_hapmap.4pca


#18. make .par file for PCA

#19. run PCA
smartpca -p AFA.par

smartpca -p HIS.par

smartpca -p CAU.par




